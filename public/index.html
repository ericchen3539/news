<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>News Digest - 新闻摘要</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.5rem; }
    section { margin: 24px 0; padding: 16px; border: 1px solid #ddd; border-radius: 8px; }
    label { display: block; margin: 8px 0 4px; font-weight: 500; }
    input, select, button { padding: 8px 12px; font-size: 1rem; }
    input[type="url"], input[type="email"], input[type="password"] { width: 100%; }
    button { cursor: pointer; background: #333; color: #fff; border: none; border-radius: 4px; }
    button:hover { background: #555; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .error { color: #c00; margin-top: 8px; }
    .success { color: #080; margin-top: 8px; }
    .hidden { display: none; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
    .checkbox-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .row { display: flex; gap: 8px; align-items: flex-end; margin: 8px 0; }
    .section-hint { color: #666; font-size: 0.9em; margin: -8px 0 12px; }
    .section-title { font-weight: 700; font-size: 1.1em; color: #1a3a52; margin: 0 0 12px; }
    .config-summary { margin-top: 12px; padding: 12px 14px; background: #f0f7ff; border: 1px solid #c5d9f0; border-radius: 6px; font-size: 1rem; font-weight: 500; color: #1a3a52; }
    .source-summary { font-size: 1rem; font-weight: 500; color: #1a3a52; margin-bottom: 12px; padding: 10px 14px; background: #f0f7ff; border: 1px solid #c5d9f0; border-radius: 6px; }
    .source-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .source-form label { margin: 0; }
    .source-form input { width: 100%; }
    .row input { flex: 1; }
    .source-list { list-style: none; padding: 0; margin: 0; border: 1px solid #c5d9f0; border-radius: 6px; background: #fafcff; }
    .source-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid #e8f0f8; }
    .source-list li:last-child { border-bottom: none; }
    .source-list li span { flex: 1; overflow: hidden; min-width: 0; }
    .source-item { display: flex; flex-direction: column; gap: 2px; }
    .source-label { font-weight: 700; font-size: 1.05em; color: #1a3a52; }
    .source-item small.source-url { color: #666; font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    nav { margin-bottom: 24px; }
    nav a { margin-right: 16px; }
    .link-btn { background:none; border:none; color:#06c; text-decoration:underline; cursor:pointer; padding:0; font-size:inherit; }
    .btn-quick-add { padding:6px 12px; font-size:0.9em; margin:2px; }
  </style>
</head>
<body>
  <h1>News Digest - 新闻摘要</h1>
  <nav>
    <a href="#" data-page="register">注册</a>
    <a href="#" data-page="login">登录</a>
    <a href="#" data-page="config" class="hidden" id="nav-config">配置</a>
    <a href="#" data-page="emails" class="hidden" id="nav-emails">发送记录</a>
    <a href="#" data-page="logout" class="hidden" id="nav-logout">退出</a>
  </nav>

  <div id="page-register" class="page">
    <section>
      <h2>注册</h2>
      <label>邮箱</label>
      <input type="email" id="reg-email" placeholder="your@email.com">
      <label>密码</label>
      <input type="password" id="reg-password" placeholder="至少6位">
      <button id="btn-register">注册</button>
      <div id="reg-msg" class="error hidden"></div>
    </section>
  </div>

  <div id="page-login" class="page">
    <section>
      <h2>登录</h2>
      <label>邮箱</label>
      <input type="email" id="login-email" placeholder="your@email.com">
      <label>密码</label>
      <input type="password" id="login-password">
      <button id="btn-login">登录</button>
      <div id="login-msg" class="error hidden"></div>
      <p class="verify-hint hidden" id="verify-hint" style="margin-top:12px;font-size:0.9em;">
        未收到验证邮件？<button type="button" id="btn-manual-verify" class="link-btn">点击此处手动验证</button>
      </p>
    </section>
  </div>

  <div id="page-config" class="page hidden">
    <section>
      <h2>新闻源</h2>
      <p class="section-title">快捷添加 Google News：</p>
      <div class="checkbox-group" id="source-quick-add"></div>
      <div class="source-summary" id="source-summary"></div>
      <ul class="source-list" id="source-list"></ul>
    </section>
    <section>
      <h2>过滤条件</h2>
      <label>模式</label>
      <select id="filter-mode">
        <option value="include">包含（匹配以下类别则保留）</option>
        <option value="exclude">排除（匹配以下类别则剔除）</option>
      </select>
      <label>预设类别（多选）</label>
      <div class="checkbox-group" id="filter-categories"></div>
      <button id="btn-save-filters">保存</button>
      <div class="config-summary" id="filter-summary"></div>
      <div id="filter-msg" class="hidden"></div>
    </section>
    <section>
      <h2>发送频率与时间</h2>
      <label>频率</label>
      <select id="schedule-frequency">
        <option value="daily">每天</option>
        <option value="weekly">每周</option>
        <option value="biweekly">每两周</option>
        <option value="monthly">每月</option>
      </select>
      <label id="label-weekday">星期几</label>
      <select id="schedule-weekday" class="hidden">
        <option value="0">周日</option>
        <option value="1" selected>周一</option>
        <option value="2">周二</option>
        <option value="3">周三</option>
        <option value="4">周四</option>
        <option value="5">周五</option>
        <option value="6">周六</option>
      </select>
      <label id="label-day" class="hidden">每月几号</label>
      <select id="schedule-day" class="hidden"></select>
      <label>发送时间（24小时制）</label>
      <div class="row">
        <select id="schedule-hour"></select>
        <span>:</span>
        <select id="schedule-minute"></select>
      </div>
      <label>时区</label>
      <select id="schedule-timezone"></select>
      <button id="btn-save-schedule">保存</button>
      <div class="config-summary" id="schedule-summary"></div>
      <div id="schedule-msg" class="hidden"></div>
    </section>
  </div>

  <div id="page-emails" class="page hidden">
    <section>
      <h2>发送记录</h2>
      <p class="section-hint">以下是发送给您的邮件记录，便于在未收到时核对。</p>
      <div id="emails-loading" class="hidden">加载中...</div>
      <div id="emails-error" class="error hidden"></div>
      <table id="emails-table" class="emails-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">类型</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">主题</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">发送时间</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">操作</th></tr>
        </thead>
        <tbody id="emails-tbody"></tbody>
      </table>
      <p id="emails-empty" class="hidden" style="margin-top:12px; color:#666;">暂无发送记录</p>
    </section>
  </div>

  <script>
    const API = '/api';
    let token = localStorage.getItem('token');
    function escapeHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    function showPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      const el = document.getElementById('page-' + name);
      if (el) el.classList.remove('hidden');
      document.getElementById('nav-config').classList.toggle('hidden', !token);
      document.getElementById('nav-emails').classList.toggle('hidden', !token);
      document.getElementById('nav-logout').classList.toggle('hidden', !token);
      if (name === 'config' && token) loadConfig();
      if (name === 'emails' && token) loadEmails();
    }

    document.querySelectorAll('[data-page]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const page = a.dataset.page;
        if (page === 'logout') { localStorage.removeItem('token'); token = null; showPage('login'); return; }
        showPage(page);
      });
    });

    async function api(path, opts = {}) {
      const headers = { 'Content-Type': 'application/json', ...opts.headers };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API + path, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText);
      return data;
    }

    document.getElementById('btn-register').addEventListener('click', async () => {
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const msg = document.getElementById('reg-msg');
      const btn = document.getElementById('btn-register');
      msg.className = 'error hidden';
      msg.textContent = '';
      if (!email || !password) {
        msg.textContent = '请填写邮箱和密码';
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return;
      }
      btn.disabled = true;
      btn.textContent = '注册中...';
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 45000);
      try {
        await api('/auth/register', {
          method: 'POST',
          body: JSON.stringify({ email, password }),
          signal: controller.signal,
        });
        clearTimeout(timeoutId);
        msg.className = 'success';
        msg.textContent = '注册成功，请查收邮件验证。';
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        clearTimeout(timeoutId);
        msg.className = 'error';
        msg.textContent = e?.name === 'AbortError' ? '请求超时，请检查网络或稍后重试' : (e?.message || '注册失败，请稍后重试');
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } finally {
        btn.disabled = false;
        btn.textContent = '注册';
      }
    });

    document.getElementById('btn-login').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const msg = document.getElementById('login-msg');
      const hint = document.getElementById('verify-hint');
      msg.className = 'error hidden';
      hint.classList.add('hidden');
      try {
        const { token: t } = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        token = t; localStorage.setItem('token', t);
        showPage('config');
      } catch (e) {
        msg.textContent = e.message; msg.classList.remove('hidden');
        if (e.message.includes('Email not verified') && email) hint.classList.remove('hidden');
      }
    });

    document.getElementById('btn-manual-verify').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const msg = document.getElementById('login-msg');
      const hint = document.getElementById('verify-hint');
      if (!email) { msg.textContent = '请先输入邮箱'; msg.classList.remove('hidden'); return; }
      try {
        await api('/auth/verify-email', { method: 'POST', body: JSON.stringify({ email }) });
        msg.className = 'success'; msg.textContent = '已验证，请重新登录。'; msg.classList.remove('hidden');
        hint.classList.add('hidden');
      } catch (e) { msg.textContent = e.message; msg.classList.remove('hidden'); }
    });

    const WEEKDAY_NAMES = ['周日','周一','周二','周三','周四','周五','周六'];

    const EMAIL_TYPE_LABELS = { verification: '验证邮件', digest: '新闻摘要' };

    function formatSentAt(ts) {
      const d = new Date(ts * 1000);
      return d.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    async function loadEmails() {
      const tbody = document.getElementById('emails-tbody');
      const loading = document.getElementById('emails-loading');
      const errEl = document.getElementById('emails-error');
      const emptyEl = document.getElementById('emails-empty');
      tbody.innerHTML = '';
      errEl.classList.add('hidden');
      emptyEl.classList.add('hidden');
      loading.classList.remove('hidden');
      try {
        const { emails } = await api('/emails');
        loading.classList.add('hidden');
        if (!emails || emails.length === 0) {
          emptyEl.classList.remove('hidden');
          return;
        }
        tbody.innerHTML = emails.map((e, i) => {
          const hasContent = e.content && e.content.trim();
          return `
          <tr><td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(EMAIL_TYPE_LABELS[e.type] || e.type)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(e.subject)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${formatSentAt(e.sent_at)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${hasContent ? `<button type="button" class="link-btn btn-view-content" data-idx="${i}">查看内容</button>` : '<span style="color:#999;">-</span>'}</td></tr>
          ${hasContent ? `<tr id="email-content-${i}" class="hidden"><td colspan="4" style="padding:12px; border-bottom:1px solid #eee; background:#fafafa;"><div class="email-content-preview" style="max-height:300px; overflow:auto; border:1px solid #ddd; padding:12px; background:#fff; font-size:0.9em;"></div></td></tr>` : ''}
        `}).join('');
        tbody.querySelectorAll('.btn-view-content').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = btn.dataset.idx;
            const contentRow = document.getElementById('email-content-' + idx);
            const preview = contentRow?.querySelector('.email-content-preview');
            const email = emails[idx];
            if (!contentRow || !preview || !email?.content) return;
            if (contentRow.classList.contains('hidden')) {
              preview.innerHTML = email.content;
              contentRow.classList.remove('hidden');
              btn.textContent = '收起';
            } else {
              contentRow.classList.add('hidden');
              btn.textContent = '查看内容';
            }
          });
        });
      } catch (e) {
        loading.classList.add('hidden');
        errEl.textContent = e.message || '加载失败';
        errEl.classList.remove('hidden');
      }
    }

    async function loadConfig() {
      const [sources, filters, schedule, presets, sourcePresets] = await Promise.all([
        api('/sources'),
        api('/filters'),
        api('/schedule'),
        api('/filter-presets'),
        api('/source-presets').catch(() => ({ googleNews: [] }))
      ]);

      const quickAdd = document.getElementById('source-quick-add');
      const gnews = sourcePresets.googleNews || [];
      quickAdd.innerHTML = gnews.map(p => `
        <button type="button" class="btn-quick-add" data-url="news.google.com" data-label="${escapeHtml(p.label)}">+ ${escapeHtml(p.label)}</button>
      `).join('');
      quickAdd.querySelectorAll('.btn-quick-add').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await api('/sources', { method: 'POST', body: JSON.stringify({ source_url: btn.dataset.url, label: btn.dataset.label }) });
            loadConfig();
          } catch (e) { alert(e.message); }
        });
      });

      const summary = document.getElementById('source-summary');
      summary.textContent = sources.length ? `已添加 ${sources.length} 个新闻源：` : '暂无新闻源，请在上方添加。';

      const list = document.getElementById('source-list');
      list.innerHTML = sources.map(s => `
        <li>
          <span class="source-item"><span class="source-label">${escapeHtml(s.label || s.source_url)}</span><small class="source-url">${escapeHtml(s.source_url)}</small></span>
          <button data-id="${s.id}" class="btn-del">删除</button>
        </li>
      `).join('');
      list.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', async () => {
          await api('/sources/' + btn.dataset.id, { method: 'DELETE' });
          loadConfig();
        });
      });

      document.getElementById('filter-mode').value = filters.mode || 'include';
      const filterCategoriesDiv = document.getElementById('filter-categories');
      filterCategoriesDiv.innerHTML = presets.map(p => `
        <label><input type="checkbox" value="${p.id}"> ${p.label}</label>
      `).join('');
      (filters.categories || []).forEach(id => {
        const cb = document.querySelector(`#filter-categories input[value="${id}"]`);
        if (cb) cb.checked = true;
      });
      const presetMap = Object.fromEntries(presets.map(p => [p.id, p.label]));
      const filterLabels = (filters.categories || []).map(id => presetMap[id] || id).filter(Boolean);
      const filterModeText = (filters.mode || 'include') === 'include' ? '包含' : '排除';
      document.getElementById('filter-summary').textContent = filterLabels.length
        ? `当前：${filterModeText}模式，已选：${filterLabels.join('、')}`
        : '当前：未选择类别';

      document.getElementById('schedule-frequency').value = schedule.frequency || 'daily';
      const [savedHour, savedMin] = (schedule.send_time || '06:00').split(':');
      document.getElementById('schedule-hour').value = savedHour?.padStart(2, '0') || '06';
      document.getElementById('schedule-minute').value = savedMin?.padStart(2, '0') || '00';
      const tzSel = document.getElementById('schedule-timezone');
      const storedTz = schedule.timezone || getSystemTimezone();
      if (!schedule.hasSchedule || storedTz === getSystemTimezone()) {
        tzSel.value = 'auto';
      } else {
        if (!TIMEZONES.some(([v]) => v === storedTz)) {
          tzSel.innerHTML += `<option value="${storedTz}">${storedTz}</option>`;
        }
        tzSel.value = storedTz;
      }
      document.getElementById('schedule-weekday').value = String(schedule.weekday ?? 1);
      document.getElementById('schedule-day').value = String(schedule.day_of_month ?? 1);

      const freq = document.getElementById('schedule-frequency').value;
      document.getElementById('schedule-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('label-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('schedule-day').classList.toggle('hidden', freq !== 'monthly');
      document.getElementById('label-day').classList.toggle('hidden', freq !== 'monthly');

      const sendTime = schedule.send_time || '06:00';
      const tz = schedule.timezone || getSystemTimezone();
      let scheduleText = '';
      if (freq === 'daily') scheduleText = `每天 ${sendTime}`;
      else if (freq === 'weekly' || freq === 'biweekly') scheduleText = `${freq === 'biweekly' ? '每两周' : '每周'}${WEEKDAY_NAMES[schedule.weekday ?? 1]} ${sendTime}`;
      else if (freq === 'monthly') scheduleText = `每月${schedule.day_of_month ?? 1}日 ${sendTime}`;
      document.getElementById('schedule-summary').textContent = `当前：${scheduleText} (${tz})`;
    }

    document.getElementById('schedule-frequency').addEventListener('change', () => {
      const freq = document.getElementById('schedule-frequency').value;
      document.getElementById('schedule-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('label-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('schedule-day').classList.toggle('hidden', freq !== 'monthly');
      document.getElementById('label-day').classList.toggle('hidden', freq !== 'monthly');
    });

    const daySelect = document.getElementById('schedule-day');
    for (let i = 1; i <= 31; i++) daySelect.innerHTML += `<option value="${i}">${i}日</option>`;

    const hourSelect = document.getElementById('schedule-hour');
    const minuteSelect = document.getElementById('schedule-minute');
    for (let i = 0; i < 24; i++) hourSelect.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}时</option>`;
    for (let i = 0; i < 60; i++) minuteSelect.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}分</option>`;
    hourSelect.value = '06';
    minuteSelect.value = '00';

    const TIMEZONES = [
      ['auto', '自动（使用系统时区）'],
      ['Asia/Shanghai', '中国 (UTC+8)'],
      ['Asia/Hong_Kong', '香港 (UTC+8)'],
      ['Asia/Taipei', '台北 (UTC+8)'],
      ['Asia/Tokyo', '东京 (UTC+9)'],
      ['Asia/Singapore', '新加坡 (UTC+8)'],
      ['Europe/London', '伦敦 (UTC+0/1)'],
      ['Europe/Paris', '巴黎 (UTC+1/2)'],
      ['Europe/Berlin', '柏林 (UTC+1/2)'],
      ['America/New_York', '纽约 (UTC-5/-4)'],
      ['America/Chicago', '芝加哥 (UTC-6/-5)'],
      ['America/Los_Angeles', '洛杉矶 (UTC-8/-7)'],
      ['Australia/Sydney', '悉尼 (UTC+10/11)'],
      ['UTC', 'UTC'],
    ];
    function getSystemTimezone() { return Intl.DateTimeFormat().resolvedOptions().timeZone; }
    function initTimezoneSelect() {
      const sel = document.getElementById('schedule-timezone');
      const sysTz = getSystemTimezone();
      sel.innerHTML = TIMEZONES.map(([val, label]) => {
        const optLabel = val === 'auto' ? `自动（当前: ${sysTz}）` : label;
        return `<option value="${val}">${optLabel}</option>`;
      }).join('');
      sel.value = 'auto';
    }
    initTimezoneSelect();

    document.getElementById('btn-save-filters').addEventListener('click', async () => {
      const mode = document.getElementById('filter-mode').value;
      const categories = [...document.querySelectorAll('#filter-categories input:checked')].map(cb => cb.value);
      const labels = [...document.querySelectorAll('#filter-categories input:checked')].map(cb => cb.parentNode.textContent.trim());
      await api('/filters', { method: 'PUT', body: JSON.stringify({ mode, categories }) });
      const msg = document.getElementById('filter-msg');
      msg.className = 'success'; msg.textContent = '已保存'; msg.classList.remove('hidden');
      document.getElementById('filter-summary').textContent = labels.length
        ? `当前：${mode === 'include' ? '包含' : '排除'}模式，已选：${labels.join('、')}`
        : '当前：未选择类别';
      setTimeout(() => msg.classList.add('hidden'), 2000);
    });

    document.getElementById('btn-save-schedule').addEventListener('click', async () => {
      const frequency = document.getElementById('schedule-frequency').value;
      const send_time = document.getElementById('schedule-hour').value + ':' + document.getElementById('schedule-minute').value;
      let timezone = document.getElementById('schedule-timezone').value.trim();
      if (timezone === 'auto') timezone = getSystemTimezone();
      const weekday = parseInt(document.getElementById('schedule-weekday').value, 10);
      const day_of_month = parseInt(document.getElementById('schedule-day').value, 10);
      await api('/schedule', { method: 'PUT', body: JSON.stringify({ frequency, send_time, timezone, weekday, day_of_month }) });
      const msg = document.getElementById('schedule-msg');
      msg.className = 'success'; msg.textContent = '已保存'; msg.classList.remove('hidden');
      let scheduleText = '';
      if (frequency === 'daily') scheduleText = `每天 ${send_time}`;
      else if (frequency === 'weekly' || frequency === 'biweekly') scheduleText = `${frequency === 'biweekly' ? '每两周' : '每周'}${WEEKDAY_NAMES[weekday]} ${send_time}`;
      else if (frequency === 'monthly') scheduleText = `每月${day_of_month}日 ${send_time}`;
      document.getElementById('schedule-summary').textContent = `当前：${scheduleText} (${timezone})`;
      setTimeout(() => msg.classList.add('hidden'), 2000);
    });

    showPage(token ? 'config' : 'register');
  </script>
</body>
</html>
