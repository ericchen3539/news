<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>News Digest - 新闻摘要</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.5rem; }
    section { margin: 24px 0; padding: 16px; border: 1px solid #ddd; border-radius: 8px; }
    label { display: block; margin: 8px 0 4px; font-weight: 500; }
    input, select, button { padding: 8px 12px; font-size: 1rem; }
    input[type="url"], input[type="email"], input[type="password"] { width: 100%; }
    button { cursor: pointer; background: #333; color: #fff; border: none; border-radius: 4px; }
    button:hover { background: #555; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .error { color: #c00; margin-top: 8px; }
    .success { color: #080; margin-top: 8px; }
    .hidden { display: none; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
    .checkbox-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .row { display: flex; gap: 8px; align-items: flex-end; margin: 8px 0; }
    .section-hint { color: #666; font-size: 0.9em; margin: -8px 0 12px; }
    .section-title { font-weight: 700; font-size: 1.1em; color: #1a3a52; margin: 0 0 12px; }
    .config-summary { margin-top: 12px; padding: 12px 14px; background: #f0f7ff; border: 1px solid #c5d9f0; border-radius: 6px; font-size: 1rem; font-weight: 500; color: #1a3a52; }
    .source-summary { font-size: 1rem; font-weight: 500; color: #1a3a52; margin-bottom: 12px; padding: 10px 14px; background: #f0f7ff; border: 1px solid #c5d9f0; border-radius: 6px; }
    .source-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .source-form label { margin: 0; }
    .source-form input { width: 100%; }
    .row input { flex: 1; }
    .source-list { list-style: none; padding: 0; margin: 0; border: 1px solid #c5d9f0; border-radius: 6px; background: #fafcff; }
    .source-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid #e8f0f8; }
    .source-list li:last-child { border-bottom: none; }
    .source-list li span { flex: 1; overflow: hidden; min-width: 0; }
    .source-item { display: flex; flex-direction: column; gap: 2px; }
    .source-label { font-weight: 700; font-size: 1.05em; color: #1a3a52; }
    .source-item small.source-url { color: #666; font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    nav { margin-bottom: 24px; }
    nav a { margin-right: 16px; }
    .link-btn { background:none; border:none; color:#06c; text-decoration:underline; cursor:pointer; padding:0; font-size:inherit; }
    .op-sep { margin: 0 0.75em; color: #999; font-weight: normal; }
    .link-btn-danger { color: #c00; font-weight: 600; }
    .link-btn-danger:hover { color: #e00; }
    .btn-quick-add { padding:6px 12px; font-size:0.9em; margin:2px; }
    #email-content-modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 16px; }
    #email-content-modal.hidden { display: none; }
    #email-content-modal .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); cursor: pointer; }
    #email-content-modal .modal-box { position: relative; max-width: min(960px, 95vw); width: 100%; max-height: 90vh; display: flex; flex-direction: column; background: #f8f6f1; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); overflow: hidden; }
    #email-content-modal .modal-box.fullscreen { max-width: none; width: 100%; height: 100%; max-height: none; border-radius: 0; }
    #email-content-modal.fullscreen { padding: 0; }
    #email-content-modal .modal-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; padding: 16px 20px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
    #email-content-modal .modal-header-info { flex: 1; min-width: 0; }
    #email-content-modal .modal-header h3 { margin: 0 0 4px; font-size: 1.1rem; color: #1a3a52; }
    #email-content-modal .modal-header .modal-meta { font-size: 0.9em; color: #666; }
    #email-content-modal .modal-actions { display: flex; gap: 4px; flex-shrink: 0; }
    #email-content-modal .modal-btn { width: 32px; height: 32px; padding: 0; font-size: 1.1rem; line-height: 1; background: transparent; color: #666; border: none; cursor: pointer; border-radius: 4px; }
    #email-content-modal .modal-btn:hover { background: #eee; color: #333; }
    #email-content-modal .modal-body { flex: 1; overflow: auto; padding: 20px; font-size: 1.05rem; line-height: 1.65; color: #333; max-width: 65ch; margin: 0 auto; width: 100%; }
    #email-content-modal .modal-body:has(table) { max-width: none; }
    #email-content-modal .modal-box.fullscreen .modal-body { max-width: none; }
    #email-content-modal .modal-body table { max-width: 100%; table-layout: fixed; }
    #email-content-modal .modal-body table th:nth-child(3),
    #email-content-modal .modal-body table td:nth-child(3) { text-align: center; }
    #email-content-modal .modal-pagination { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 20px; background: #fff; border-top: 1px solid #ddd; flex-shrink: 0; }
    #email-content-modal .modal-pagination.hidden { display: none; }
    #email-content-modal .modal-pagination button { padding: 6px 12px; font-size: 0.9rem; }
    .digest-card { margin-bottom: 16px; padding: 14px 16px; background: #fff; border: 1px solid #e5e5e5; border-radius: 6px; }
    .digest-card:last-child { margin-bottom: 0; }
    .digest-card-link { text-decoration: none; color: inherit; display: block; }
    .digest-card-link:hover .digest-card-title { color: #06c; }
    .digest-card-title { margin: 0 0 4px; font-size: 1.15rem; font-weight: 600; color: #1a3a52; line-height: 1.35; }
    .digest-card-title-zh { margin: 0 0 8px; font-size: 0.9em; color: #555; line-height: 1.4; }
    .digest-card-meta { margin: 0; font-size: 0.9em; color: #666; line-height: 1.5; }
    .digest-card-source { display: inline-block; margin-right: 8px; font-weight: 500; color: #666; }
    #email-content-modal .modal-body:has(.digest-card) { max-width: none; }
  </style>
</head>
<body>
  <h1>News Digest - 新闻摘要</h1>
  <nav>
    <a href="#" data-page="register">注册</a>
    <a href="#" data-page="login">登录</a>
    <a href="#" data-page="config" class="hidden" id="nav-config">配置</a>
    <a href="#" data-page="emails" class="hidden" id="nav-emails">发送记录</a>
    <a href="#" data-page="logout" class="hidden" id="nav-logout">退出</a>
  </nav>

  <div id="page-register" class="page">
    <section>
      <h2>注册</h2>
      <label>邮箱</label>
      <input type="email" id="reg-email" placeholder="your@email.com">
      <label>密码</label>
      <input type="password" id="reg-password" placeholder="至少6位">
      <button id="btn-register">注册</button>
      <div id="reg-msg" class="error hidden"></div>
    </section>
  </div>

  <div id="page-login" class="page">
    <section>
      <h2>登录</h2>
      <label>邮箱</label>
      <input type="email" id="login-email" placeholder="your@email.com">
      <label>密码</label>
      <input type="password" id="login-password">
      <button id="btn-login">登录</button>
      <div id="login-msg" class="error hidden"></div>
      <p class="verify-hint hidden" id="verify-hint" style="margin-top:12px;font-size:0.9em;">
        未收到验证邮件？<button type="button" id="btn-manual-verify" class="link-btn">点击此处手动验证</button>
      </p>
    </section>
  </div>

  <div id="page-config" class="page hidden">
    <section>
      <h2>新闻源</h2>
      <p class="section-title">快捷添加 Google News：</p>
      <div class="checkbox-group" id="source-quick-add"></div>
      <div class="source-summary" id="source-summary"></div>
      <ul class="source-list" id="source-list"></ul>
    </section>
    <section>
      <h2>过滤条件</h2>
      <label>模式</label>
      <select id="filter-mode">
        <option value="include">包含（匹配以下类别则保留）</option>
        <option value="exclude">排除（匹配以下类别则剔除）</option>
      </select>
      <label>预设类别（多选）</label>
      <div class="checkbox-group" id="filter-categories"></div>
      <button id="btn-save-filters">保存</button>
      <div class="config-summary" id="filter-summary"></div>
      <div id="filter-msg" class="hidden"></div>
    </section>
    <section>
      <h2>发送频率与时间</h2>
      <label>频率</label>
      <input type="text" id="schedule-frequency" list="schedule-frequency-list" placeholder="daily/weekly/biweekly/monthly" autocomplete="off">
      <datalist id="schedule-frequency-list">
        <option value="daily">每天</option>
        <option value="weekly">每周</option>
        <option value="biweekly">每两周</option>
        <option value="monthly">每月</option>
      </datalist>
      <label id="label-weekday">星期几</label>
      <input type="text" id="schedule-weekday" list="schedule-weekday-list" class="hidden" placeholder="0-6" autocomplete="off">
      <datalist id="schedule-weekday-list">
        <option value="0">周日</option>
        <option value="1">周一</option>
        <option value="2">周二</option>
        <option value="3">周三</option>
        <option value="4">周四</option>
        <option value="5">周五</option>
        <option value="6">周六</option>
      </datalist>
      <label id="label-day" class="hidden">每月几号</label>
      <input type="text" id="schedule-day" list="schedule-day-list" class="hidden" placeholder="1-31" autocomplete="off">
      <datalist id="schedule-day-list"></datalist>
      <label>发送时间（24小时制）</label>
      <div class="row">
        <input type="text" id="schedule-hour" list="schedule-hour-list" placeholder="00-23" style="width:4em;" autocomplete="off">
        <span>:</span>
        <input type="text" id="schedule-minute" list="schedule-minute-list" placeholder="00-59" style="width:4em;" autocomplete="off">
      </div>
      <datalist id="schedule-hour-list"></datalist>
      <datalist id="schedule-minute-list"></datalist>
      <label>时区</label>
      <select id="schedule-timezone"></select>
      <button id="btn-save-schedule">保存</button>
      <div class="config-summary" id="schedule-summary"></div>
      <div id="schedule-msg" class="hidden"></div>
    </section>
  </div>

  <div id="page-emails" class="page hidden">
    <section>
      <h2>发送记录</h2>
      <p class="section-hint">以下是发送给您的邮件记录，便于在未收到时核对。</p>
      <div id="emails-batch-actions" class="hidden" style="margin-bottom:8px;">
        <span id="emails-selected-info" style="color:#666;"></span>
        <button type="button" id="btn-batch-delete" class="link-btn" style="margin-left:12px;">批量删除</button>
      </div>
      <div id="emails-loading" class="hidden">加载中...</div>
      <div id="emails-error" class="error hidden"></div>
      <table id="emails-table" class="emails-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr><th style="text-align:center; padding:8px; border-bottom:1px solid #ddd; width:36px;"><input type="checkbox" id="emails-select-all-th" title="全选"></th><th style="text-align:center; padding:8px; border-bottom:1px solid #ddd;">主题</th><th style="text-align:center; padding:8px; border-bottom:1px solid #ddd;">发送时间</th><th style="text-align:center; padding:8px; border-bottom:1px solid #ddd;">操作</th></tr>
        </thead>
        <tbody id="emails-tbody"></tbody>
      </table>
      <p id="emails-empty" class="hidden" style="margin-top:12px; color:#666;">暂无发送记录</p>
    </section>
  </div>

  <div id="email-content-modal" class="hidden">
    <div class="modal-overlay" id="email-modal-overlay"></div>
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-header-info">
          <h3 id="email-modal-subject"></h3>
          <div class="modal-meta" id="email-modal-meta"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="modal-btn" id="email-modal-fullscreen" title="全屏">⛶</button>
          <button type="button" class="modal-btn" id="email-modal-close" title="关闭">×</button>
        </div>
      </div>
      <div class="modal-body" id="email-modal-body"></div>
      <div class="modal-pagination hidden" id="email-modal-pagination">
        <button type="button" id="email-modal-prev">上一页</button>
        <span id="email-modal-page-info"></span>
        <button type="button" id="email-modal-next">下一页</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';
    let token = localStorage.getItem('token');
    function escapeHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    function showPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      const el = document.getElementById('page-' + name);
      if (el) el.classList.remove('hidden');
      document.getElementById('nav-config').classList.toggle('hidden', !token);
      document.getElementById('nav-emails').classList.toggle('hidden', !token);
      document.getElementById('nav-logout').classList.toggle('hidden', !token);
      if (name === 'config' && token) loadConfig();
      if (name === 'emails' && token) loadEmails();
    }

    document.querySelectorAll('[data-page]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const page = a.dataset.page;
        if (page === 'logout') { localStorage.removeItem('token'); token = null; showPage('login'); return; }
        showPage(page);
      });
    });

    async function api(path, opts = {}) {
      const headers = { 'Content-Type': 'application/json', ...opts.headers };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API + path, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText);
      return data;
    }

    document.getElementById('btn-register').addEventListener('click', async () => {
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const msg = document.getElementById('reg-msg');
      const btn = document.getElementById('btn-register');
      msg.className = 'error hidden';
      msg.textContent = '';
      if (!email || !password) {
        msg.textContent = '请填写邮箱和密码';
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return;
      }
      btn.disabled = true;
      btn.textContent = '注册中...';
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 45000);
      try {
        await api('/auth/register', {
          method: 'POST',
          body: JSON.stringify({ email, password }),
          signal: controller.signal,
        });
        clearTimeout(timeoutId);
        msg.className = 'success';
        msg.textContent = '注册成功，请查收邮件验证。';
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        clearTimeout(timeoutId);
        msg.className = 'error';
        msg.textContent = e?.name === 'AbortError' ? '请求超时，请检查网络或稍后重试' : (e?.message || '注册失败，请稍后重试');
        msg.classList.remove('hidden');
        msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } finally {
        btn.disabled = false;
        btn.textContent = '注册';
      }
    });

    document.getElementById('btn-login').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const msg = document.getElementById('login-msg');
      const hint = document.getElementById('verify-hint');
      msg.className = 'error hidden';
      hint.classList.add('hidden');
      try {
        const { token: t } = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        token = t; localStorage.setItem('token', t);
        showPage('config');
      } catch (e) {
        msg.textContent = e.message; msg.classList.remove('hidden');
        if (e.message.includes('Email not verified') && email) hint.classList.remove('hidden');
      }
    });

    document.getElementById('btn-manual-verify').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const msg = document.getElementById('login-msg');
      const hint = document.getElementById('verify-hint');
      if (!email) { msg.textContent = '请先输入邮箱'; msg.classList.remove('hidden'); return; }
      try {
        await api('/auth/verify-email', { method: 'POST', body: JSON.stringify({ email }) });
        msg.className = 'success'; msg.textContent = '已验证，请重新登录。'; msg.classList.remove('hidden');
        hint.classList.add('hidden');
      } catch (e) { msg.textContent = e.message; msg.classList.remove('hidden'); }
    });

    const WEEKDAY_NAMES = ['周日','周一','周二','周三','周四','周五','周六'];

    const EMAIL_TYPE_LABELS = { verification: '验证邮件', digest: '新闻摘要' };

    function formatSentAt(ts) {
      const d = new Date(ts * 1000);
      return d.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    async function loadEmails() {
      const tbody = document.getElementById('emails-tbody');
      const loading = document.getElementById('emails-loading');
      const errEl = document.getElementById('emails-error');
      const emptyEl = document.getElementById('emails-empty');
      tbody.innerHTML = '';
      errEl.classList.add('hidden');
      emptyEl.classList.add('hidden');
      loading.classList.remove('hidden');
      try {
        const { emails } = await api('/emails');
        loading.classList.add('hidden');
        if (!emails || emails.length === 0) {
          document.getElementById('emails-batch-actions').classList.add('hidden');
          emptyEl.classList.remove('hidden');
          return;
        }
        document.getElementById('emails-batch-actions').classList.remove('hidden');
        const selectAllTh = document.getElementById('emails-select-all-th');
        const selectedInfo = document.getElementById('emails-selected-info');
        const btnBatchDelete = document.getElementById('btn-batch-delete');
        function updateBatchUI() {
          const checked = tbody.querySelectorAll('.email-row-check:checked');
          const n = checked.length;
          selectedInfo.textContent = n ? `已选 ${n} 条` : '';
          btnBatchDelete.disabled = n === 0;
          selectAllTh.checked = n > 0 && n === emails.length;
          selectAllTh.indeterminate = n > 0 && n < emails.length;
        }
        tbody.innerHTML = emails.map((e, i) => {
          const hasContent = e.content && e.content.trim();
          const actions = (hasContent ? `<button type="button" class="link-btn btn-view-content" data-idx="${i}">查看内容</button><span class="op-sep">|</span>` : '') + `<button type="button" class="link-btn link-btn-danger btn-delete-email" data-id="${e.id}">删除</button>`;
          return `<tr><td style="padding:8px; border-bottom:1px solid #eee;"><input type="checkbox" class="email-row-check" data-id="${e.id}"></td><td style="padding:8px; border-bottom:1px solid #eee;">${escapeHtml(e.subject)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${formatSentAt(e.sent_at)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${actions}</td></tr>`;
        }).join('');
        selectAllTh.checked = false;
        selectAllTh.indeterminate = false;
        selectAllTh.onchange = () => {
          tbody.querySelectorAll('.email-row-check').forEach(cb => { cb.checked = selectAllTh.checked; });
          updateBatchUI();
        };
        tbody.onchange = (e) => { if (e.target.classList.contains('email-row-check')) updateBatchUI(); };
        updateBatchUI();
        btnBatchDelete.onclick = async () => {
          const ids = Array.from(tbody.querySelectorAll('.email-row-check:checked')).map(cb => parseInt(cb.dataset.id, 10));
          if (!ids.length || !confirm(`确定要永久删除选中的 ${ids.length} 条记录吗？`)) return;
          try {
            await api('/emails/batch-delete', { method: 'POST', body: JSON.stringify({ ids }) });
            loadEmails();
          } catch (err) { alert(err.message || '删除失败'); }
        };
        tbody.querySelectorAll('.btn-delete-email').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('确定要永久删除这条记录吗？')) return;
            try {
              await api('/emails/' + btn.dataset.id, { method: 'DELETE' });
              loadEmails();
            } catch (err) { alert(err.message || '删除失败'); }
          });
        });
        const modalEl = document.getElementById('email-content-modal');
        const fullscreenBtn = document.getElementById('email-modal-fullscreen');
        function closeEmailModal() {
          if (document.fullscreenElement === modalEl) document.exitFullscreen?.();
          modalEl.classList.add('hidden');
          document.removeEventListener('keydown', handleModalEscape);
        }
        function handleModalEscape(e) {
          if (e.key === 'Escape') {
            if (document.fullscreenElement === modalEl) document.exitFullscreen?.();
            else closeEmailModal();
          }
        }
        const modalBox = modalEl.querySelector('.modal-box');
        function updateFullscreenBtn() {
          const isFullscreen = document.fullscreenElement === modalEl;
          fullscreenBtn.textContent = isFullscreen ? '✕' : '⛶';
          fullscreenBtn.title = isFullscreen ? '退出全屏' : '全屏';
          modalEl.classList.toggle('fullscreen', isFullscreen);
          modalBox.classList.toggle('fullscreen', isFullscreen);
        }
        fullscreenBtn.onclick = () => {
          if (document.fullscreenElement === modalEl) document.exitFullscreen?.();
          else modalEl.requestFullscreen?.();
        };
        modalEl.addEventListener('fullscreenchange', updateFullscreenBtn);
        const PAGE_SIZE = 5;
        let paginatedRows = [];
        let currentPage = 1;
        const bodyEl = document.getElementById('email-modal-body');
        function setLinksOpenInNewTab(container) {
          (container || bodyEl).querySelectorAll('a[href]').forEach((a) => {
            a.setAttribute('target', '_blank');
            a.setAttribute('rel', 'noopener noreferrer');
          });
        }
        const paginationEl = document.getElementById('email-modal-pagination');
        const prevBtn = document.getElementById('email-modal-prev');
        const nextBtn = document.getElementById('email-modal-next');
        const pageInfoEl = document.getElementById('email-modal-page-info');
        function parseRowToCardData(tr) {
          const tds = tr.querySelectorAll('td');
          if (tds.length < 3) return null;
          const linkEl = tds[0].querySelector('a') || tds[2].querySelector('a');
          const link = linkEl?.getAttribute('href') || linkEl?.href || '#';
          const divs = tds[0].querySelectorAll('div');
          const title = (divs[0]?.textContent || tds[0].textContent || '').trim();
          const titleZh = (divs[1]?.textContent || '').trim();
          const summary = (tds[1].textContent || '').trim();
          const source = (tds[2].textContent || '').trim();
          return { title, titleZh, summary, source, link };
        }
        function buildCardHtml(data) {
          return `<article class="digest-card">
  <a href="${escapeHtml(data.link)}" target="_blank" rel="noopener noreferrer" class="digest-card-link">
    <h4 class="digest-card-title">${escapeHtml(data.title)}</h4>
    ${data.titleZh ? `<p class="digest-card-title-zh">${escapeHtml(data.titleZh)}</p>` : ''}
  </a>
  <p class="digest-card-meta">
    <span class="digest-card-source">${escapeHtml(data.source)}</span>
    <span class="digest-card-summary">${escapeHtml(data.summary)}</span>
  </p>
</article>`;
        }
        function rowsToCardsHtml(rows) {
          return rows.map((tr) => {
            const data = parseRowToCardData(tr);
            return data ? buildCardHtml(data) : '';
          }).filter(Boolean).join('');
        }
        function renderPaginatedContent() {
          const totalPages = Math.ceil(paginatedRows.length / PAGE_SIZE) || 1;
          const start = (currentPage - 1) * PAGE_SIZE;
          const end = start + PAGE_SIZE;
          const rows = paginatedRows.slice(start, end);
          bodyEl.innerHTML = paginatedRows.length ? `<div class="digest-card-list">${rowsToCardsHtml(rows)}</div>` : '';
          setLinksOpenInNewTab();
          pageInfoEl.textContent = `第 ${currentPage} / ${totalPages} 页（共 ${paginatedRows.length} 条）`;
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= totalPages;
        }
        function openEmailModal(email) {
          document.getElementById('email-modal-subject').textContent = email.subject || '(无主题)';
          document.getElementById('email-modal-meta').textContent = `${EMAIL_TYPE_LABELS[email.type] || email.type} · ${formatSentAt(email.sent_at)}`;
          const parser = document.createElement('div');
          parser.innerHTML = email.content || '';
          const table = parser.querySelector('table');
          const tbodyRows = table?.querySelectorAll('tbody tr');
          if (tbodyRows && tbodyRows.length > 0) {
            if (tbodyRows.length > PAGE_SIZE) {
              paginatedRows = Array.from(tbodyRows);
              currentPage = 1;
              paginationEl.classList.remove('hidden');
              renderPaginatedContent();
              prevBtn.onclick = () => { currentPage--; renderPaginatedContent(); };
              nextBtn.onclick = () => { currentPage++; renderPaginatedContent(); };
            } else {
              bodyEl.innerHTML = `<div class="digest-card-list">${rowsToCardsHtml(Array.from(tbodyRows))}</div>`;
              setLinksOpenInNewTab();
              paginationEl.classList.add('hidden');
            }
          } else {
            bodyEl.innerHTML = email.content || '';
            setLinksOpenInNewTab();
            paginationEl.classList.add('hidden');
          }
          modalEl.classList.remove('hidden');
          updateFullscreenBtn();
          document.addEventListener('keydown', handleModalEscape);
        }
        document.getElementById('email-modal-close').onclick = closeEmailModal;
        document.getElementById('email-modal-overlay').onclick = closeEmailModal;
        tbody.querySelectorAll('.btn-view-content').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.idx, 10);
            const email = emails[idx];
            if (!email?.content) return;
            openEmailModal(email);
          });
        });
      } catch (e) {
        loading.classList.add('hidden');
        errEl.textContent = e.message || '加载失败';
        errEl.classList.remove('hidden');
      }
    }

    async function loadConfig() {
      const [sources, filters, schedule, presets, sourcePresets] = await Promise.all([
        api('/sources'),
        api('/filters'),
        api('/schedule'),
        api('/filter-presets'),
        api('/source-presets').catch(() => ({ googleNews: [] }))
      ]);

      const quickAdd = document.getElementById('source-quick-add');
      const gnews = sourcePresets.googleNews || [];
      quickAdd.innerHTML = gnews.map(p => `
        <button type="button" class="btn-quick-add" data-url="news.google.com" data-label="${escapeHtml(p.label)}">+ ${escapeHtml(p.label)}</button>
      `).join('');
      quickAdd.querySelectorAll('.btn-quick-add').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await api('/sources', { method: 'POST', body: JSON.stringify({ source_url: btn.dataset.url, label: btn.dataset.label }) });
            loadConfig();
          } catch (e) { alert(e.message); }
        });
      });

      const summary = document.getElementById('source-summary');
      summary.textContent = sources.length ? `已添加 ${sources.length} 个新闻源：` : '暂无新闻源，请在上方添加。';

      const list = document.getElementById('source-list');
      list.innerHTML = sources.map(s => `
        <li>
          <span class="source-item"><span class="source-label">${escapeHtml(s.label || s.source_url)}</span><small class="source-url">${escapeHtml(s.source_url)}</small></span>
          <button data-id="${s.id}" class="btn-del">删除</button>
        </li>
      `).join('');
      list.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', async () => {
          await api('/sources/' + btn.dataset.id, { method: 'DELETE' });
          loadConfig();
        });
      });

      document.getElementById('filter-mode').value = filters.mode || 'include';
      const filterCategoriesDiv = document.getElementById('filter-categories');
      filterCategoriesDiv.innerHTML = presets.map(p => `
        <label><input type="checkbox" value="${p.id}"> ${p.label}</label>
      `).join('');
      (filters.categories || []).forEach(id => {
        const cb = document.querySelector(`#filter-categories input[value="${id}"]`);
        if (cb) cb.checked = true;
      });
      const presetMap = Object.fromEntries(presets.map(p => [p.id, p.label]));
      const filterLabels = (filters.categories || []).map(id => presetMap[id] || id).filter(Boolean);
      const filterModeText = (filters.mode || 'include') === 'include' ? '包含' : '排除';
      document.getElementById('filter-summary').textContent = filterLabels.length
        ? `当前：${filterModeText}模式，已选：${filterLabels.join('、')}`
        : '当前：未选择类别';

      document.getElementById('schedule-frequency').value = schedule.frequency || 'daily';
      const [savedHour, savedMin] = (schedule.send_time || '06:00').split(':');
      document.getElementById('schedule-hour').value = savedHour?.padStart(2, '0') || '06';
      document.getElementById('schedule-minute').value = savedMin?.padStart(2, '0') || '00';
      const tzSel = document.getElementById('schedule-timezone');
      const storedTz = schedule.timezone || getSystemTimezone();
      if (!schedule.hasSchedule || storedTz === getSystemTimezone()) {
        tzSel.value = 'auto';
      } else {
        if (!TIMEZONES.some(([v]) => v === storedTz)) {
          tzSel.innerHTML += `<option value="${storedTz}">${storedTz}</option>`;
        }
        tzSel.value = storedTz;
      }
      document.getElementById('schedule-weekday').value = String(schedule.weekday ?? 1);
      document.getElementById('schedule-day').value = String(schedule.day_of_month ?? 1);

      const freq = document.getElementById('schedule-frequency').value;
      document.getElementById('schedule-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('label-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('schedule-day').classList.toggle('hidden', freq !== 'monthly');
      document.getElementById('label-day').classList.toggle('hidden', freq !== 'monthly');

      const sendTime = schedule.send_time || '06:00';
      const tz = schedule.timezone || getSystemTimezone();
      let scheduleText = '';
      if (freq === 'daily') scheduleText = `每天 ${sendTime}`;
      else if (freq === 'weekly' || freq === 'biweekly') scheduleText = `${freq === 'biweekly' ? '每两周' : '每周'}${WEEKDAY_NAMES[schedule.weekday ?? 1]} ${sendTime}`;
      else if (freq === 'monthly') scheduleText = `每月${schedule.day_of_month ?? 1}日 ${sendTime}`;
      document.getElementById('schedule-summary').textContent = `当前：${scheduleText} (${tz})`;
    }

    const FREQ_MAP = { '每天':'daily', '每周':'weekly', '每两周':'biweekly', '每月':'monthly' };
    function normFreq(v) { return FREQ_MAP[v?.trim()] || v?.trim() || 'daily'; }
    function toggleFreqFields() {
      const freq = normFreq(document.getElementById('schedule-frequency').value);
      document.getElementById('schedule-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('label-weekday').classList.toggle('hidden', !['weekly','biweekly'].includes(freq));
      document.getElementById('schedule-day').classList.toggle('hidden', freq !== 'monthly');
      document.getElementById('label-day').classList.toggle('hidden', freq !== 'monthly');
    }
    document.getElementById('schedule-frequency').addEventListener('input', toggleFreqFields);
    document.getElementById('schedule-frequency').addEventListener('change', toggleFreqFields);

    const dayDatalist = document.getElementById('schedule-day-list');
    for (let i = 1; i <= 31; i++) dayDatalist.innerHTML += `<option value="${i}">${i}日</option>`;

    const hourDatalist = document.getElementById('schedule-hour-list');
    const minuteDatalist = document.getElementById('schedule-minute-list');
    for (let i = 0; i < 24; i++) hourDatalist.innerHTML += `<option value="${String(i).padStart(2,'0')}">`;
    for (let i = 0; i < 60; i++) minuteDatalist.innerHTML += `<option value="${String(i).padStart(2,'0')}">`;

    const TIMEZONES = [
      ['auto', '自动（使用系统时区）'],
      ['Asia/Shanghai', '中国 (UTC+8)'],
      ['Asia/Hong_Kong', '香港 (UTC+8)'],
      ['Asia/Taipei', '台北 (UTC+8)'],
      ['Asia/Tokyo', '东京 (UTC+9)'],
      ['Asia/Singapore', '新加坡 (UTC+8)'],
      ['Europe/London', '伦敦 (UTC+0/1)'],
      ['Europe/Paris', '巴黎 (UTC+1/2)'],
      ['Europe/Berlin', '柏林 (UTC+1/2)'],
      ['America/New_York', '纽约 (UTC-5/-4)'],
      ['America/Chicago', '芝加哥 (UTC-6/-5)'],
      ['America/Los_Angeles', '洛杉矶 (UTC-8/-7)'],
      ['Australia/Sydney', '悉尼 (UTC+10/11)'],
      ['UTC', 'UTC'],
    ];
    function getSystemTimezone() { return Intl.DateTimeFormat().resolvedOptions().timeZone; }
    function initTimezoneSelect() {
      const sel = document.getElementById('schedule-timezone');
      const sysTz = getSystemTimezone();
      sel.innerHTML = TIMEZONES.map(([val, label]) => {
        const optLabel = val === 'auto' ? `自动（当前: ${sysTz}）` : label;
        return `<option value="${val}">${optLabel}</option>`;
      }).join('');
      sel.value = 'auto';
    }
    initTimezoneSelect();

    document.getElementById('btn-save-filters').addEventListener('click', async () => {
      const mode = document.getElementById('filter-mode').value;
      const categories = [...document.querySelectorAll('#filter-categories input:checked')].map(cb => cb.value);
      const labels = [...document.querySelectorAll('#filter-categories input:checked')].map(cb => cb.parentNode.textContent.trim());
      await api('/filters', { method: 'PUT', body: JSON.stringify({ mode, categories }) });
      const msg = document.getElementById('filter-msg');
      msg.className = 'success'; msg.textContent = '已保存'; msg.classList.remove('hidden');
      document.getElementById('filter-summary').textContent = labels.length
        ? `当前：${mode === 'include' ? '包含' : '排除'}模式，已选：${labels.join('、')}`
        : '当前：未选择类别';
      setTimeout(() => msg.classList.add('hidden'), 2000);
    });

    document.getElementById('btn-save-schedule').addEventListener('click', async () => {
      const frequency = normFreq(document.getElementById('schedule-frequency').value);
      const h = String(parseInt(document.getElementById('schedule-hour').value, 10) || 0).padStart(2, '0');
      const m = String(parseInt(document.getElementById('schedule-minute').value, 10) || 0).padStart(2, '0');
      const send_time = (parseInt(h,10)>=0&&parseInt(h,10)<=23 ? h : '06') + ':' + (parseInt(m,10)>=0&&parseInt(m,10)<=59 ? m : '00');
      let timezone = document.getElementById('schedule-timezone').value.trim();
      if (timezone === 'auto') timezone = getSystemTimezone();
      const weekday = parseInt(document.getElementById('schedule-weekday').value, 10);
      const day_of_month = Math.min(31, Math.max(1, parseInt(document.getElementById('schedule-day').value, 10) || 1));
      const wd = (weekday >= 0 && weekday <= 6) ? weekday : 1;
      await api('/schedule', { method: 'PUT', body: JSON.stringify({ frequency, send_time, timezone, weekday, day_of_month }) });
      const msg = document.getElementById('schedule-msg');
      msg.className = 'success'; msg.textContent = '已保存'; msg.classList.remove('hidden');
      let scheduleText = '';
      if (frequency === 'daily') scheduleText = `每天 ${send_time}`;
      else if (frequency === 'weekly' || frequency === 'biweekly') scheduleText = `${frequency === 'biweekly' ? '每两周' : '每周'}${WEEKDAY_NAMES[wd]} ${send_time}`;
      else if (frequency === 'monthly') scheduleText = `每月${day_of_month}日 ${send_time}`;
      document.getElementById('schedule-summary').textContent = `当前：${scheduleText} (${timezone})`;
      setTimeout(() => msg.classList.add('hidden'), 2000);
    });

    showPage(token ? 'config' : 'register');
  </script>
</body>
</html>
